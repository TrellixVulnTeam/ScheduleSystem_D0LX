/*!
    *
    * Wijmo Library 5.20203.748
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{assert,isArray,isString,isNumber,isUndefined,asBoolean,getTypes,getType,tryCast,toHeaderCase,addClass,DataType,Binding,Control,CollectionView,ObservableArray,NotifyCollectionChangedEventArgs,NotifyCollectionChangedAction,_registerModule}from"@grapecity/wijmo";import{FlexGrid,Row,Column,ColumnCollection,AllowSorting,HeadersVisibility}from"@grapecity/wijmo.grid";import*as selfModule from"@grapecity/wijmo.grid.transposed";export class TransposedGrid extends FlexGrid{constructor(e,t){super(e,null);this._keyPrefix="item";this._autoGenRows=!0;addClass(this.hostElement,"wj-transposed-grid");this.allowSorting=AllowSorting.None;this.headersVisibility=HeadersVisibility.Row;this._rowInfo=new ColumnCollection(this,this.columns.defaultSize);this.initialize(t);this._rowInfo.collectionChanged.addHandler(this._rowInfoChanged,this);this.deferUpdate(()=>{let e=this.rowHeaders.columns;if(e.length){e[e.length-1].width=this.columns.defaultSize}})}get autoGenerateRows(){return this._autoGenRows}set autoGenerateRows(e){this._autoGenRows=asBoolean(e)}refresh(e){let t=this._rowInfo;if(t._dirty){t._dirty=!1;this._rowInfoChanged()}else super.refresh(e)}get allowAddNew(){return!1}set allowAddNew(e){}get allowDelete(){return!1}set allowDelete(e){}get allowSorting(){return AllowSorting.None}set allowSorting(e){assert(e===AllowSorting.None,"TransposedGrid does not support sorting.");this._alSorting=e}onRowEditEnded(e){let t=tryCast(this._sourceItems,"ICollectionView");if(t){let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change);t.collectionChanged.raise(t,e)}super.onRowEditEnded(e)}_getCollectionView(e){let t=tryCast(this._sourceItems,"ICollectionView");t&&t.collectionChanged.removeHandler(this._sourceViewChanged);t=tryCast(e,"ICollectionView");let o=e;if(isArray(e))o=this._transposeItemsSource(e);else if(t){t.collectionChanged.addHandler(this._sourceViewChanged,this);o=this._transposeItemsSource(t.items)}this.autoGenerateColumns=!0;let i=super._getCollectionView(o),r=null;t instanceof CollectionView&&(r=t.getError);r&&i instanceof CollectionView&&(this._supportsProxies()?i.getError=(e,t)=>{let o=e._keys.indexOf(t);return r(e._arr[o],e._bnd.path)}:i.getError=(e,t)=>{let o=parseInt(t.substr(this._keyPrefix.length));return r(e._arr[o],e._rowInfo.binding)});this._sourceItems=e;return i}_getColumnTypes(e){let t,o;if(this._sourceItems)if(isArray(this._sourceItems))o=this._sourceItems;else{let e=tryCast(this._sourceItems,"ICollectionView");e&&(o=e.items)}return t=o?o.map((e,t)=>({binding:this._keyPrefix+t,dataType:DataType.Object})):getTypes(e)}_copy(e,t){if(/rows|columns/.test(e)){assert(isArray(t),"Array Expected.");this._rowInfo.deferUpdate(()=>{this.autoGenerateRows=!1;this._rowInfo.clear();t.forEach(e=>{let t=new Column(e);this._rowInfo.push(t)})});return!0}return super._copy(e,t)}onLoadedRows(e){let t=this.rowHeaders.columns;for(let e=0;e<t.length;e++)t[e].align="left";let o=this.columns;for(let e=0;e<o.length;e++){let t=o[e];t.align=null;t.dataType=0}let i=FlexGrid._getSerializableProperties(Row);this.rows.forEach(e=>{let o=e.dataItem._rowInfo;if(o){this._copyProps(o,e,i,"showDropDown");if(t.length){let i=o.header||toHeaderCase(o.binding);this.rowHeaders.setCellData(e.index,t.length-1,i)}}});super.onLoadedRows(e)}_getBindingColumn(e,t,o){let i=o;if(e!=this.cells)return i;let r=e.rows[t].dataItem._rowInfo;if(isUndefined(r))return i;i=new Column;let n=FlexGrid._getSerializableProperties(Column);this._copyProps(r,i,n);i.binding=o.binding;i.header=r.header||toHeaderCase(r.binding);return i}_copyProps(e,t,o,i=""){for(let r in e)if(o.indexOf(r)>-1&&r!=i){let o=e[r];if(!isUndefined(o))try{t[r]=o}catch(e){}}}_rowInfoChanged(){this._toRowInfo&&clearTimeout(this._toRowInfo);this._toRowInfo=setTimeout(()=>{let e=this.selection,t=this.itemsSource;this.itemsSource=null;this.itemsSource=t;this.selection=e},Control._REFRESH_INTERVAL)}_sourceViewChanged(e,t){this.activeEditor||this.invalidate()}_transposeItemsSource(e){let t=new ObservableArray,o=getTypes(e),i=e.map((e,t)=>this._keyPrefix+t);(this.autoGenerateRows?this._getRowInfo(e):this._rowInfo).forEach((r,n)=>{let s=new Binding(r.binding);if(null==r.dataType){let t=s.getValue(e[0]);r.dataType=null!=t?getType(t):o[n].dataType}if(this._supportsProxies()){let o=this._createProxy(e,r,i);t.push(o)}else{let o=this._createTransposedObject(e,r,this._keyPrefix);t.push(o)}});e instanceof ObservableArray&&e.collectionChanged.addHandler((e,o)=>{if(o.action===NotifyCollectionChangedAction.Change)this.activeEditor||this.invalidate();else{let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Reset);t.onCollectionChanged(e);this._rowInfoChanged()}});return t}_supportsProxies(){return null!=window.Proxy}_createProxy(e,t,o){let i={_arr:e,_rowInfo:t,_bnd:new Binding(t.binding),_keys:o};return new Proxy(i,{ownKeys:e=>e._keys,getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0,writable:!0}),get:(e,t)=>{let o=e._keys.indexOf(t);return o>-1?e._bnd.getValue(e._arr[o]):e[t]},set:(e,t,o)=>{let i=e._keys.indexOf(t);if(i>-1){let t=e._arr,r=t[i];e._bnd.setValue(r,o);if(t instanceof ObservableArray){let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,r,i);t.onCollectionChanged(e)}return!0}return!1}})}_createTransposedObject(e,t,o){let i={_arr:e,_rowInfo:t},r=new Binding(t.binding);for(let t=0;t<e.length;t++){let n=e[t];Object.defineProperty(i,o+t,{enumerable:!0,get:()=>r.getValue(n),set:o=>{r.setValue(n,o);if(e instanceof ObservableArray){let o=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,n,t);e.onCollectionChanged(o)}return!0}})}return i}_getRowInfo(e){let t=[];getTypes(e).forEach(e=>{let o=e.binding,i=e.dataType;if(i!=DataType.Object&&i!=DataType.Array){let e={binding:o,header:toHeaderCase(o),dataType:i},r=FlexGrid._defTypeWidth[i];if(null!=r){if(isString(r)){let e=Math.round(parseFloat(r));r=r.indexOf("*")<0?e:e*this.columns.defaultSize}isNumber(r)&&r>0&&(e.width=r)}t.push(e)}});return t}}export class TransposedGridRow extends Column{}_registerModule("wijmo.grid.transposed",selfModule);