/*!
    *
    * Wijmo Library 5.20203.748
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.hasOwnProperty.call(e,i)&&(t[i]=e[i]);t.default=e;return t};Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("@grapecity/wijmo"),wijmo_grid_1=require("@grapecity/wijmo.grid"),selfModule=__importStar(require("@grapecity/wijmo.grid.transposed"));class TransposedGrid extends wijmo_grid_1.FlexGrid{constructor(e,t){super(e,null);this._keyPrefix="item";this._autoGenRows=!0;wijmo_1.addClass(this.hostElement,"wj-transposed-grid");this.allowSorting=wijmo_grid_1.AllowSorting.None;this.headersVisibility=wijmo_grid_1.HeadersVisibility.Row;this._rowInfo=new wijmo_grid_1.ColumnCollection(this,this.columns.defaultSize);this.initialize(t);this._rowInfo.collectionChanged.addHandler(this._rowInfoChanged,this);this.deferUpdate(()=>{let e=this.rowHeaders.columns;if(e.length){e[e.length-1].width=this.columns.defaultSize}})}get autoGenerateRows(){return this._autoGenRows}set autoGenerateRows(e){this._autoGenRows=wijmo_1.asBoolean(e)}refresh(e){let t=this._rowInfo;if(t._dirty){t._dirty=!1;this._rowInfoChanged()}else super.refresh(e)}get allowAddNew(){return!1}set allowAddNew(e){}get allowDelete(){return!1}set allowDelete(e){}get allowSorting(){return wijmo_grid_1.AllowSorting.None}set allowSorting(e){wijmo_1.assert(e===wijmo_grid_1.AllowSorting.None,"TransposedGrid does not support sorting.");this._alSorting=e}onRowEditEnded(e){let t=wijmo_1.tryCast(this._sourceItems,"ICollectionView");if(t){let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change);t.collectionChanged.raise(t,e)}super.onRowEditEnded(e)}_getCollectionView(e){let t=wijmo_1.tryCast(this._sourceItems,"ICollectionView");t&&t.collectionChanged.removeHandler(this._sourceViewChanged);t=wijmo_1.tryCast(e,"ICollectionView");let i=e;if(wijmo_1.isArray(e))i=this._transposeItemsSource(e);else if(t){t.collectionChanged.addHandler(this._sourceViewChanged,this);i=this._transposeItemsSource(t.items)}this.autoGenerateColumns=!0;let o=super._getCollectionView(i),r=null;t instanceof wijmo_1.CollectionView&&(r=t.getError);r&&o instanceof wijmo_1.CollectionView&&(this._supportsProxies()?o.getError=(e,t)=>{let i=e._keys.indexOf(t);return r(e._arr[i],e._bnd.path)}:o.getError=(e,t)=>{let i=parseInt(t.substr(this._keyPrefix.length));return r(e._arr[i],e._rowInfo.binding)});this._sourceItems=e;return o}_getColumnTypes(e){let t,i;if(this._sourceItems)if(wijmo_1.isArray(this._sourceItems))i=this._sourceItems;else{let e=wijmo_1.tryCast(this._sourceItems,"ICollectionView");e&&(i=e.items)}return t=i?i.map((e,t)=>({binding:this._keyPrefix+t,dataType:wijmo_1.DataType.Object})):wijmo_1.getTypes(e)}_copy(e,t){if(/rows|columns/.test(e)){wijmo_1.assert(wijmo_1.isArray(t),"Array Expected.");this._rowInfo.deferUpdate(()=>{this.autoGenerateRows=!1;this._rowInfo.clear();t.forEach(e=>{let t=new wijmo_grid_1.Column(e);this._rowInfo.push(t)})});return!0}return super._copy(e,t)}onLoadedRows(e){let t=this.rowHeaders.columns;for(let e=0;e<t.length;e++)t[e].align="left";let i=this.columns;for(let e=0;e<i.length;e++){let t=i[e];t.align=null;t.dataType=0}let o=wijmo_grid_1.FlexGrid._getSerializableProperties(wijmo_grid_1.Row);this.rows.forEach(e=>{let i=e.dataItem._rowInfo;if(i){this._copyProps(i,e,o,"showDropDown");if(t.length){let o=i.header||wijmo_1.toHeaderCase(i.binding);this.rowHeaders.setCellData(e.index,t.length-1,o)}}});super.onLoadedRows(e)}_getBindingColumn(e,t,i){let o=i;if(e!=this.cells)return o;let r=e.rows[t].dataItem._rowInfo;if(wijmo_1.isUndefined(r))return o;o=new wijmo_grid_1.Column;let n=wijmo_grid_1.FlexGrid._getSerializableProperties(wijmo_grid_1.Column);this._copyProps(r,o,n);o.binding=i.binding;o.header=r.header||wijmo_1.toHeaderCase(r.binding);return o}_copyProps(e,t,i,o=""){for(let r in e)if(i.indexOf(r)>-1&&r!=o){let i=e[r];if(!wijmo_1.isUndefined(i))try{t[r]=i}catch(e){}}}_rowInfoChanged(){this._toRowInfo&&clearTimeout(this._toRowInfo);this._toRowInfo=setTimeout(()=>{let e=this.selection,t=this.itemsSource;this.itemsSource=null;this.itemsSource=t;this.selection=e},wijmo_1.Control._REFRESH_INTERVAL)}_sourceViewChanged(e,t){this.activeEditor||this.invalidate()}_transposeItemsSource(e){let t=new wijmo_1.ObservableArray,i=wijmo_1.getTypes(e),o=e.map((e,t)=>this._keyPrefix+t);(this.autoGenerateRows?this._getRowInfo(e):this._rowInfo).forEach((r,n)=>{let s=new wijmo_1.Binding(r.binding);if(null==r.dataType){let t=s.getValue(e[0]);r.dataType=null!=t?wijmo_1.getType(t):i[n].dataType}if(this._supportsProxies()){let i=this._createProxy(e,r,o);t.push(i)}else{let i=this._createTransposedObject(e,r,this._keyPrefix);t.push(i)}});e instanceof wijmo_1.ObservableArray&&e.collectionChanged.addHandler((e,i)=>{if(i.action===wijmo_1.NotifyCollectionChangedAction.Change)this.activeEditor||this.invalidate();else{let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Reset);t.onCollectionChanged(e);this._rowInfoChanged()}});return t}_supportsProxies(){return null!=window.Proxy}_createProxy(e,t,i){let o={_arr:e,_rowInfo:t,_bnd:new wijmo_1.Binding(t.binding),_keys:i};return new Proxy(o,{ownKeys:e=>e._keys,getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0,writable:!0}),get:(e,t)=>{let i=e._keys.indexOf(t);return i>-1?e._bnd.getValue(e._arr[i]):e[t]},set:(e,t,i)=>{let o=e._keys.indexOf(t);if(o>-1){let t=e._arr,r=t[o];e._bnd.setValue(r,i);if(t instanceof wijmo_1.ObservableArray){let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,r,o);t.onCollectionChanged(e)}return!0}return!1}})}_createTransposedObject(e,t,i){let o={_arr:e,_rowInfo:t},r=new wijmo_1.Binding(t.binding);for(let t=0;t<e.length;t++){let n=e[t];Object.defineProperty(o,i+t,{enumerable:!0,get:()=>r.getValue(n),set:i=>{r.setValue(n,i);if(e instanceof wijmo_1.ObservableArray){let i=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,n,t);e.onCollectionChanged(i)}return!0}})}return o}_getRowInfo(e){let t=[];wijmo_1.getTypes(e).forEach(e=>{let i=e.binding,o=e.dataType;if(o!=wijmo_1.DataType.Object&&o!=wijmo_1.DataType.Array){let e={binding:i,header:wijmo_1.toHeaderCase(i),dataType:o},r=wijmo_grid_1.FlexGrid._defTypeWidth[o];if(null!=r){if(wijmo_1.isString(r)){let e=Math.round(parseFloat(r));r=r.indexOf("*")<0?e:e*this.columns.defaultSize}wijmo_1.isNumber(r)&&r>0&&(e.width=r)}t.push(e)}});return t}}exports.TransposedGrid=TransposedGrid;class TransposedGridRow extends wijmo_grid_1.Column{}exports.TransposedGridRow=TransposedGridRow;wijmo_1._registerModule("wijmo.grid.transposed",selfModule);